---
import Base from '../layouts/Base.astro';
import { tools, categories, getToolsCountByCategory } from '../data/tools';
import en from '../locales/en.json';
import zhCN from '../locales/zh-CN.json';
import zhTW from '../locales/zh-TW.json';
import jaJP from '../locales/ja-JP.json';
import ar from '../locales/ar.json';
import ru from '../locales/ru.json';

// é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å·¥å…·
const defaultTools = tools;
---

<Base
  title="OumaShu - Tools Directory | All-in-One Productivity Hub"
  description="Curated tools directory to boost your productivity. Browse by category for free online tools including video, audio, text, image converters, and more."
  keywords="tools, productivity, online tools, free tools, utilities, web apps, screen recorder, chat, converter, directory"
>
  <div class="min-h-screen flex">
    <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden" aria-hidden="true"></div>

    <!-- å·¦ä¾§è¾¹æ  -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-black border-r border-gray-200 dark:border-gray-700 fixed h-full overflow-y-auto flex flex-col z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
      <!-- Logo -->
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-3">
          <img src="/logo.png" alt="OumaShu Logo" class="w-8 h-8" />
          <div>
            <h1 class="text-xl font-bold text-gray-900 dark:text-white">OumaShu</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400">Tools Directory</p>
          </div>
        </div>
      </div>

      <!-- åˆ†ç±»åˆ—è¡¨ -->
      <nav class="p-4">
        <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
          Tool Categories
        </h2>
        <ul class="space-y-1" id="category-list">
          <!-- æ‰€æœ‰å·¥å…·é€‰é¡¹ -->
          <li>
            <button
              data-category="all"
              class="
                w-full flex items-center justify-between px-3 py-2 rounded-lg text-left transition-all duration-200
                bg-sakura-50 dark:bg-sakura-900/20 text-sakura-600 dark:text-sakura-400 border border-sakura-200 dark:border-sakura-800
                category-btn
              "
            >
              <div class="flex items-center space-x-3">
                <img src="/icons/classification/all.png" alt="All Tools" class="w-5 h-5 object-contain" />
                <span class="font-medium">All Tools</span>
              </div>
              <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full">
                {tools.length}
              </span>
            </button>
          </li>
          
          {categories.map((category) => {
            const toolCount = getToolsCountByCategory(tools, category.id);
            return (
              <li>
                <button
                  data-category={category.id}
                  class="
                    w-full flex items-center justify-between px-3 py-2 rounded-lg text-left transition-all duration-200
                    text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700
                    category-btn
                  "
                >
                  <div class="flex items-center space-x-3">
                    <img src={category.icon} alt={category.name} class="w-5 h-5 object-contain" />
                    <span class="font-medium">{category.name}</span>
                  </div>
                  <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full">
                    {toolCount}
                  </span>
                </button>
              </li>
            );
          })}
        </ul>
      </nav>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="p-4 mt-auto border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-black">
        <div class="flex items-center justify-between">
          <!-- ä¸»é¢˜åˆ‡æ¢ -->
          <div class="relative">
            <button 
              id="theme-toggle-btn"
              class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              title="ä¸»é¢˜åˆ‡æ¢"
            >
              <span id="theme-icon" class="text-lg">ğŸ’»</span>
            </button>
          </div>
          
          <!-- è¯­è¨€åˆ‡æ¢ -->
          <div class="relative">
            <button 
              id="language-toggle-btn"
              class="flex items-center space-x-1 px-2 py-1 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              title="è¯­è¨€åˆ‡æ¢"
            >
              <span id="language-flag">ğŸ‡¨ğŸ‡³</span>
              <span class="text-xs">â–¼</span>
            </button>
            
            <!-- è¯­è¨€ä¸‹æ‹‰èœå• -->
            <div 
              id="language-dropdown" 
              class="hidden absolute bottom-full mb-2 right-0 w-44 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50"
            >
              <div class="py-1">
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="zh-CN">
                  <span>ğŸ‡¨ğŸ‡³</span>
                  <span>ç®€ä½“ä¸­æ–‡</span>
                </button>
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="zh-TW">
                  <span>ğŸ‡¹ğŸ‡¼</span>
                  <span>ç¹é«”ä¸­æ–‡</span>
                </button>
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="en">
                  <span>ğŸ‡ºğŸ‡¸</span>
                  <span>English</span>
                </button>
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="ja-JP">
                  <span>ğŸ‡¯ğŸ‡µ</span>
                  <span>æ—¥æœ¬èª</span>
                </button>
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="ar">
                  <span>ğŸ‡¸ğŸ‡¦</span>
                  <span>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                </button>
                <button class="language-option w-full flex items-center space-x-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-locale="ru">
                  <span>ğŸ‡·ğŸ‡º</span>
                  <span>Ğ ÑƒÑÑĞºĞ¸Ğ¹</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 lg:ml-64 bg-gray-50 dark:bg-black min-h-screen">
      <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨æ  -->
      <div class="lg:hidden bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 py-3 sticky top-0 z-20">
        <div class="flex items-center justify-between">
          <button id="mobile-menu-btn" class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
          <div class="flex items-center space-x-2">
            <img src="/logo.png" alt="OumaShu Logo" class="w-6 h-6" />
            <span class="text-lg font-bold text-gray-900 dark:text-white">OumaShu</span>
          </div>
          <div class="w-10"></div> <!-- å ä½ç¬¦ä¿æŒå±…ä¸­ -->
        </div>
      </div>

      <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
      <header class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 lg:px-8 py-4 lg:py-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center" id="category-title">
              <img src="/icons/classification/all.png" alt="All Tools" class="mr-3 w-8 h-8 object-contain" />
              All Tools
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mt-1" id="category-description">
              Collection of all practical tools to boost your productivity
            </p>
          </div>
          <div class="text-sm text-gray-500 dark:text-gray-400" id="tools-count-text">
            <span id="tools-count">{defaultTools.length}</span> <span id="tools-count-unit">tools</span>
          </div>
        </div>
      </header>

      <!-- Introduction Section -->
      <section class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 lg:px-8 py-8" id="intro-section">
        <div class="max-w-4xl">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4" id="intro-title">
            Welcome to OumaShu - Your Ultimate Productivity Hub
          </h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed mb-4" id="intro-paragraph">
            OumaShu is a carefully curated directory of free online tools designed to boost your productivity 
            and creativity. Whether you're looking for text processing tools, image editors, video converters, 
            or entertainment apps, we've got you covered. All tools are hand-picked for quality, ease of use, 
            and privacy protection.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div class="flex items-start space-x-3">
              <span class="text-2xl">ğŸ†“</span>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1" id="intro-feature-free-title">100% Free</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="intro-feature-free-desc">
                  All tools are completely free to use with no hidden costs or subscriptions required.
                </p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-2xl">ğŸ”’</span>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1" id="intro-feature-privacy-title">Privacy First</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="intro-feature-privacy-desc">
                  Most tools process data locally in your browser, ensuring your privacy and security.
                </p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <span class="text-2xl">âš¡</span>
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-1" id="intro-feature-noinstall-title">No Installation</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="intro-feature-noinstall-desc">
                  Access all tools directly in your browser without downloading or installing anything.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- å·¥å…·åˆ—è¡¨è§†å›¾ï¼ˆæ‰€æœ‰å·¥å…·æ—¶æ˜¾ç¤ºï¼‰ -->
      <div class="p-4 lg:p-8 bg-gray-50 dark:bg-black" id="all-tools-list">
        {categories.map((category) => {
          const categoryTools = tools.filter(tool => tool.category === category.id);
          if (categoryTools.length === 0) return null;
          
          return (
            <div class="mb-8 category-section" data-category-id={category.id}>
              <div class="flex items-center mb-4">
                <img src={category.icon} alt={category.name} class="w-7 h-7 object-contain mr-3" />
                <h3 class="text-xl font-bold text-gray-900 dark:text-white category-name">
                  {category.name}
                </h3>
                <span class="ml-3 text-sm text-gray-500 dark:text-gray-400 category-count">
                  ({categoryTools.length})
                </span>
              </div>
              <div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                  {categoryTools.map((tool, index) => (
                    <a
                      href={tool.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center px-3 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors group tool-link"
                      data-tool-id={tool.id}
                    >
                      <span class="text-lg mr-2">{tool.icon || 'ğŸ”—'}</span>
                      <span class="text-gray-900 dark:text-white text-sm font-medium truncate tool-name">
                        {tool.name}
                      </span>
                      {tool.thirdParty && (
                        <span class="ml-1 text-xs text-gray-400 third-party-indicator">
                          ğŸ”—
                        </span>
                      )}
                      <svg class="w-3 h-3 ml-auto text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                      </svg>
                    </a>
                  ))}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <!-- å·¥å…·å¡ç‰‡è§†å›¾ï¼ˆå…·ä½“åˆ†ç±»æ—¶æ˜¾ç¤ºï¼‰ -->
      <div class="p-4 lg:p-8 bg-gray-50 dark:bg-black hidden" id="category-tools-grid">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="tools-grid">
          <!-- å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="text-6xl mb-4">ğŸ”</div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2" id="empty-state-title">
            No tools in this category
          </h3>
          <p class="text-gray-600 dark:text-gray-400" id="empty-state-desc">
            More tools are coming soon!
          </p>
        </div>
      </div>

      <!-- Footer -->
      <footer class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 px-4 lg:px-8 py-8 mt-12">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
            <div>
              <div class="flex items-center space-x-2 mb-3">
                <img src="/logo.png" alt="OumaShu Logo" class="w-6 h-6" />
                <h3 class="font-bold text-gray-900 dark:text-white">OumaShu</h3>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Your ultimate productivity hub. Discover free online tools to boost your workflow.
              </p>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Quick Links</h3>
              <ul class="space-y-2">
                <li>
                  <a href="/" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    Home
                  </a>
                </li>
                <li>
                  <a href="/about" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    About Us
                  </a>
                </li>
                <li>
                  <a href="/privacy" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    Privacy Policy
                  </a>
                </li>
              </ul>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Contact</h3>
              <ul class="space-y-2">
                <li>
                  <a href="mailto:wanghongxiang23@gmail.com" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    Email: wanghongxiang23@gmail.com
                  </a>
                </li>
                <li>
                  <a href="https://x.com/Rollkey4" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                    X: @Rollkey4
                  </a>
                </li>
                <li class="text-sm text-gray-600 dark:text-gray-400">
                  Website: oumashu.top
                </li>
              </ul>
            </div>
          </div>
          <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
            <p class="text-center text-sm text-gray-600 dark:text-gray-400">
              Â© 2024 OumaShu. All rights reserved.
            </p>
          </div>
        </div>
      </footer>
    </main>
  </div>
</Base>

<!-- å·¥å…·æ•°æ® -->
<script>
  import { tools, categories } from '../data/tools';
  import en from '../locales/en.json';
  import zhCN from '../locales/zh-CN.json';
  import zhTW from '../locales/zh-TW.json';
  import jaJP from '../locales/ja-JP.json';
  import ar from '../locales/ar.json';
  import ru from '../locales/ru.json';

  window.toolsData = tools;
  window.categoriesData = categories;
  
  const translations = {
    'en': en,
    'zh-CN': zhCN,
    'zh-TW': zhTW,
    'ja-JP': jaJP,
    'ar': ar,
    'ru': ru
  };
  window.translations = translations;

  document.addEventListener('DOMContentLoaded', () => {
    // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    function openSidebar() {
      sidebar?.classList.remove('-translate-x-full');
      sidebarOverlay?.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    }
    
    function closeSidebar() {
      sidebar?.classList.add('-translate-x-full');
      sidebarOverlay?.classList.add('hidden');
      document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
    }
    
    mobileMenuBtn?.addEventListener('click', openSidebar);
    sidebarOverlay?.addEventListener('click', closeSidebar);
    
    // ç‚¹å‡»ä¾§è¾¹æ åˆ†ç±»æŒ‰é’®ååœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
    const categoryButtons = document.querySelectorAll('.category-btn');
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (window.innerWidth < 1024) { // lgæ–­ç‚¹
          closeSidebar();
        }
      });
    });
    
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeIcon = document.getElementById('theme-icon');
    
    // è·å–å½“å‰ä¸»é¢˜
    function getCurrentTheme() {
      return localStorage.getItem('theme') || 'system';
    }
    
    // è·å–å®é™…ä¸»é¢˜ï¼ˆå¤„ç† system æ¨¡å¼ï¼‰
    function getActualTheme(theme) {
      if (theme === 'system') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      return theme;
    }
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
      const actualTheme = getActualTheme(theme);
      document.documentElement.setAttribute('data-theme', actualTheme);
      
      // æ›´æ–°å›¾æ ‡
      const icons = { light: 'â˜€ï¸', dark: 'ğŸŒ™', system: 'ğŸ’»' };
      themeIcon.textContent = icons[theme] || 'ğŸ’»';
      
      // æ›´æ–° meta theme-color
      const metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (metaThemeColor) {
        metaThemeColor.setAttribute('content', actualTheme === 'dark' ? '#000000' : '#fff5f7');
      }
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜
    let currentTheme = getCurrentTheme();
    applyTheme(currentTheme);
    
    // ä¸»é¢˜åˆ‡æ¢ç‚¹å‡»äº‹ä»¶
    themeToggleBtn.addEventListener('click', () => {
      const themes = ['light', 'dark', 'system'];
      const currentIndex = themes.indexOf(currentTheme);
      const nextIndex = (currentIndex + 1) % themes.length;
      currentTheme = themes[nextIndex];
      
      localStorage.setItem('theme', currentTheme);
      applyTheme(currentTheme);
    });
    
    // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
    const languageToggleBtn = document.getElementById('language-toggle-btn');
    const languageDropdown = document.getElementById('language-dropdown');
    const languageFlag = document.getElementById('language-flag');
    const languageOptions = document.querySelectorAll('.language-option');
    
    // åˆ†ç±»å’Œå·¥å…·ç›¸å…³å…ƒç´ 
    // categoryButtons å·²åœ¨ä¸Šé¢å®šä¹‰
    const categoryTitle = document.getElementById('category-title');
    const categoryDescription = document.getElementById('category-description');
    const toolsCount = document.getElementById('tools-count');
    const allToolsList = document.getElementById('all-tools-list');
    const categoryToolsGrid = document.getElementById('category-tools-grid');
    const toolsGrid = document.getElementById('tools-grid');
    const emptyState = document.getElementById('empty-state');
    const introSection = document.getElementById('intro-section');
    
    const localeData = {
      'zh-CN': { flag: 'ğŸ‡¨ğŸ‡³', name: 'ç®€ä½“ä¸­æ–‡' },
      'zh-TW': { flag: 'ğŸ‡¹ğŸ‡¼', name: 'ç¹é«”ä¸­æ–‡' },
      'en': { flag: 'ğŸ‡ºğŸ‡¸', name: 'English' },
      'ja-JP': { flag: 'ğŸ‡¯ğŸ‡µ', name: 'æ—¥æœ¬èª' },
      'ar': { flag: 'ğŸ‡¸ğŸ‡¦', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
      'ru': { flag: 'ğŸ‡·ğŸ‡º', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' }
    };

    // ç¿»è¯‘æ˜ å°„ - ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„ translations

    // æ ¹æ®IPè‡ªåŠ¨æ£€æµ‹è¯­è¨€
    async function detectLocaleByIP() {
      try {
        // é¦–å…ˆæ£€æŸ¥localStorageæ˜¯å¦æœ‰ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„è¯­è¨€
        const savedLocale = localStorage.getItem('locale');
        if (savedLocale) {
          return savedLocale;
        }
        
        // ä½¿ç”¨å…è´¹çš„IPåœ°ç†ä½ç½®APIæ£€æµ‹ç”¨æˆ·ä½ç½®
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        
        // æ ¹æ®å›½å®¶ä»£ç æ˜ å°„åˆ°è¯­è¨€
        const countryToLocale = {
          'CN': 'zh-CN',     // ä¸­å›½å¤§é™†
          'TW': 'zh-TW',     // å°æ¹¾
          'HK': 'zh-TW',     // é¦™æ¸¯
          'MO': 'zh-TW',     // æ¾³é—¨
          'JP': 'ja-JP',     // æ—¥æœ¬
          'RU': 'ru',        // ä¿„ç½—æ–¯
          'BY': 'ru',        // ç™½ä¿„ç½—æ–¯
          'KZ': 'ru',        // å“ˆè¨å…‹æ–¯å¦
          'KG': 'ru',        // å‰å°”å‰æ–¯æ–¯å¦
          'SA': 'ar',        // æ²™ç‰¹é˜¿æ‹‰ä¼¯
          'AE': 'ar',        // é˜¿è”é…‹
          'EG': 'ar',        // åŸƒåŠ
          'JO': 'ar',        // çº¦æ—¦
          'LB': 'ar',        // é»å·´å«©
          'SY': 'ar',        // å™åˆ©äºš
          'IQ': 'ar',        // ä¼Šæ‹‰å…‹
          'KW': 'ar',        // ç§‘å¨ç‰¹
          'QA': 'ar',        // å¡å¡”å°”
          'BH': 'ar',        // å·´æ—
          'OM': 'ar',        // é˜¿æ›¼
          'YE': 'ar',        // ä¹Ÿé—¨
          'MA': 'ar',        // æ‘©æ´›å“¥
          'TN': 'ar',        // çªå°¼æ–¯
          'DZ': 'ar',        // é˜¿å°”åŠåˆ©äºš
          'LY': 'ar',        // åˆ©æ¯”äºš
          'SD': 'ar',        // è‹ä¸¹
        };
        
        return countryToLocale[data.country_code] || 'en'; // é»˜è®¤è‹±è¯­
      } catch (error) {
        console.log('IP detection failed, using default locale:', error);
        return 'en'; // æ£€æµ‹å¤±è´¥æ—¶é»˜è®¤è‹±è¯­
      }
    }
    
    // è·å–å½“å‰è¯­è¨€
    let currentLocale = 'en'; // ä¸´æ—¶è®¾ç½®ä¸ºè‹±è¯­ï¼Œç­‰å¾…æ£€æµ‹ç»“æœ
    
    // å¼‚æ­¥æ£€æµ‹å¹¶è®¾ç½®è¯­è¨€
    detectLocaleByIP().then(detectedLocale => {
      currentLocale = detectedLocale;
      languageFlag.textContent = localeData[currentLocale]?.flag || 'ğŸ‡ºğŸ‡¸';
      
      // åˆå§‹åŒ–é¡µé¢æ–‡æœ¬
      updatePageText(currentLocale);
      
      // æ›´æ–°å·¥å…·å’Œåˆ†ç±»æ–‡æœ¬
      updateToolsAndCategories(currentLocale);
      
      console.log('Auto-detected locale:', currentLocale);
    });
    
    // è®¾ç½®åˆå§‹è¯­è¨€æ ‡å¿—ä¸ºè‹±è¯­
    languageFlag.textContent = localeData['en']?.flag || 'ğŸ‡ºğŸ‡¸';
    
    // åˆå§‹æ˜¾ç¤ºè‹±æ–‡ï¼ˆåœ¨IPæ£€æµ‹å®Œæˆå‰ï¼‰
    updatePageText('en');
    // åˆå§‹åŒ–æ—¶æ˜¾ç¤º"æ‰€æœ‰å·¥å…·"ï¼Œä¸æ˜¾ç¤ºç‰¹å®šåˆ†ç±»
    // categoryTitle å’Œ categoryDescription å·²åœ¨é¡¶å±‚å£°æ˜
    const initialT = translations['en'];
    if (categoryTitle) {
      categoryTitle.innerHTML = `<img src="/icons/classification/all.png" alt="All Tools" class="mr-3 w-8 h-8 object-contain inline-block" />${initialT.all_tools || 'All Tools'}`;
    }
    if (categoryDescription) {
      categoryDescription.textContent = initialT.all_tools_desc || 'Collection of all practical tools to boost your productivity';
    }
    
    // æ›´æ–°å·¥å…·åç§°å’Œåˆ†ç±»æ ‡é¢˜
    function updateToolsAndCategories(locale) {
      const t = translations[locale] || translations['en'];
      
      // æ›´æ–°åˆ†ç±»æ ‡é¢˜
      document.querySelectorAll('.category-section').forEach(section => {
        const categoryId = section.dataset.categoryId;
        const categoryNameElem = section.querySelector('.category-name');
        
        if (categoryNameElem && t.categories && t.categories[categoryId]) {
          categoryNameElem.textContent = t.categories[categoryId];
        }
      });
      
      // æ›´æ–°å·¥å…·åç§°
      document.querySelectorAll('.tool-link').forEach(link => {
        const toolId = link.dataset.toolId;
        const toolNameElem = link.querySelector('.tool-name');
        
        if (toolNameElem && toolId && t.tools && t.tools[toolId]) {
          toolNameElem.textContent = t.tools[toolId].name;
        }
      });
    }
    
    // åˆå§‹æ›´æ–°ä¸ºè‹±æ–‡
    updateToolsAndCategories('en');

    // æ›´æ–°é¡µé¢æ–‡æœ¬çš„å‡½æ•°
    function updatePageText(locale) {
      const t = translations[locale] || translations['en'];
      
      // æ›´æ–°ç«™ç‚¹æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
      const siteSubtitle = document.querySelector('p.text-sm.text-gray-600');
      if (siteSubtitle) {
        siteSubtitle.textContent = t.site_subtitle;
      }
      
      // æ›´æ–°åˆ†ç±»æ ‡é¢˜
      const categoriesTitle = document.querySelector('h2.text-sm.font-semibold');
      if (categoriesTitle) {
        categoriesTitle.textContent = t.categories_title;
      }
      
      // æ›´æ–°åˆ†ç±»æŒ‰é’®æ–‡æœ¬
      categoryButtons.forEach(btn => {
        const categoryId = btn.dataset.category;
        const nameSpan = btn.querySelector('span.font-medium');
        if (nameSpan) {
          if (categoryId === 'all') {
            nameSpan.textContent = t.all_tools || 'All Tools';
          } else if (t.categories[categoryId]) {
            nameSpan.textContent = t.categories[categoryId];
          }
        }
      });
      
      // æ›´æ–°å·¥å…·è®¡æ•°æ–‡æœ¬
      const toolsCountUnit = document.getElementById('tools-count-unit');
      if (toolsCountUnit) {
        toolsCountUnit.textContent = t.tools_count;
      }
      
      // æ›´æ–°æ¨èæ ‡ç­¾æ–‡æœ¬
      const featuredTexts = document.querySelectorAll('.featured-text');
      featuredTexts.forEach(el => {
        el.textContent = t.featured_text;
      });
      
      // æ›´æ–°ç¬¬ä¸‰æ–¹æ ‡ç­¾æ–‡æœ¬
      const thirdPartyTexts = document.querySelectorAll('.third-party-text');
      thirdPartyTexts.forEach(el => {
        el.textContent = t.third_party_text;
      });
      
      // æ›´æ–°æŒ‰é’®title
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const languageToggleBtn = document.getElementById('language-toggle-btn');
      if (themeToggleBtn) themeToggleBtn.title = t.theme_toggle_title;
      if (languageToggleBtn) languageToggleBtn.title = t.language_toggle_title;
      
      // æ›´æ–°ç©ºçŠ¶æ€æ–‡æœ¬
      const emptyStateTitle = document.querySelector('#empty-state-title');
      const emptyStateDesc = document.querySelector('#empty-state-desc');
      if (emptyStateTitle) emptyStateTitle.textContent = t.empty_state_title;
      if (emptyStateDesc) emptyStateDesc.textContent = t.empty_state_desc;
      
      // æ›´æ–°å¡ç‰‡ä¸­çš„ç¬¬ä¸‰æ–¹æ ‡ç­¾æ–‡æœ¬
      document.querySelectorAll('.third-party-text').forEach(el => {
        el.textContent = t.third_party_text;
      });
      
      // æ›´æ–°ä»‹ç»åŒºæ–‡æœ¬ï¼ˆä»…åœ¨æ‰€æœ‰å·¥å…·é¡µé¢æ˜¾ç¤ºï¼Œä½†åœ¨ä»»ä½•è¯­è¨€åˆ‡æ¢æ—¶éƒ½æ›´æ–°æ–‡æ¡ˆï¼‰
      const introTitle = document.getElementById('intro-title');
      const introParagraph = document.getElementById('intro-paragraph');
      const introFreeTitle = document.getElementById('intro-feature-free-title');
      const introFreeDesc = document.getElementById('intro-feature-free-desc');
      const introPrivacyTitle = document.getElementById('intro-feature-privacy-title');
      const introPrivacyDesc = document.getElementById('intro-feature-privacy-desc');
      const introNoInstallTitle = document.getElementById('intro-feature-noinstall-title');
      const introNoInstallDesc = document.getElementById('intro-feature-noinstall-desc');

      if (introTitle && t.intro_title) introTitle.textContent = t.intro_title;
      if (introParagraph && t.intro_paragraph) introParagraph.textContent = t.intro_paragraph;
      if (introFreeTitle && t.intro_feature_free_title) introFreeTitle.textContent = t.intro_feature_free_title;
      if (introFreeDesc && t.intro_feature_free_desc) introFreeDesc.textContent = t.intro_feature_free_desc;
      if (introPrivacyTitle && t.intro_feature_privacy_title) introPrivacyTitle.textContent = t.intro_feature_privacy_title;
      if (introPrivacyDesc && t.intro_feature_privacy_desc) introPrivacyDesc.textContent = t.intro_feature_privacy_desc;
      if (introNoInstallTitle && t.intro_feature_noinstall_title) introNoInstallTitle.textContent = t.intro_feature_noinstall_title;
      if (introNoInstallDesc && t.intro_feature_noinstall_desc) introNoInstallDesc.textContent = t.intro_feature_noinstall_desc;
      
      // æ›´æ–°å½“å‰åˆ†ç±»æè¿°å’Œæ ‡é¢˜
      const categoryDesc = document.getElementById('category-description');
      const categoryTitleElem = document.getElementById('category-title');
      if (categoryDesc || categoryTitleElem) {
        const currentCategoryBtn = document.querySelector('.category-btn.bg-sakura-50, .category-btn[class*="bg-sakura"]');
        if (currentCategoryBtn) {
          const categoryId = currentCategoryBtn.dataset.category;
          
          if (categoryId === 'all') {
            // å¦‚æœæ˜¯"æ‰€æœ‰å·¥å…·"
            if (categoryTitleElem) {
              categoryTitleElem.innerHTML = `<img src="/icons/classification/all.png" alt="All Tools" class="mr-3 w-8 h-8 object-contain inline-block" />${t.all_tools || 'All Tools'}`;
            }
            if (categoryDesc) {
              categoryDesc.textContent = t.all_tools_desc || 'Collection of all practical tools to boost your productivity';
            }
          } else {
            // å¦‚æœæ˜¯å…·ä½“åˆ†ç±»
            const category = window.categoriesData.find(cat => cat.id === categoryId);
            if (category) {
              const translatedName = (t.categories && t.categories[categoryId]) || category.name;
              const translatedDesc = (t.category_descriptions && t.category_descriptions[categoryId]) || category.description;
              
              if (categoryTitleElem) {
                categoryTitleElem.innerHTML = `<img src="${category.icon}" alt="${translatedName}" class="mr-3 w-8 h-8 object-contain inline-block" />${translatedName}`;
              }
              if (categoryDesc) {
                categoryDesc.textContent = translatedDesc;
              }
            }
          }
        }
      }
      
      // æ›´æ–°å·¥å…·åç§°å’Œåˆ†ç±»æ ‡é¢˜
      updateToolsAndCategories(locale);
    }
    
    // è¯­è¨€åˆ‡æ¢æŒ‰é’®ç‚¹å‡»
    languageToggleBtn.addEventListener('click', () => {
      languageDropdown.classList.toggle('hidden');
    });
    
    // è¯­è¨€é€‰é¡¹ç‚¹å‡»
    languageOptions.forEach(option => {
      option.addEventListener('click', () => {
        const locale = option.dataset.locale;
        localStorage.setItem('locale', locale);
        currentLocale = locale;
        
        // æ›´æ–°æ˜¾ç¤º
        languageFlag.textContent = localeData[locale]?.flag || 'ğŸ‡ºğŸ‡¸';
        languageDropdown.classList.add('hidden');
        
        // é˜²æ­¢é˜¿æ‹‰ä¼¯è¯­æ”¹å˜å¸ƒå±€ - æš‚æ—¶ç¦ç”¨RTL
        document.documentElement.lang = locale;
        // document.documentElement.dir = locale === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.dir = 'ltr'; // å¼ºåˆ¶ä¿æŒLTRå¸ƒå±€
        
        // æ›´æ–°é¡µé¢æ–‡æœ¬
        updatePageText(locale);
        
        // æ›´æ–°å·¥å…·å’Œåˆ†ç±»æ–‡æœ¬
        updateToolsAndCategories(locale);
        
        // å¦‚æœå½“å‰åœ¨å¡ç‰‡è§†å›¾ï¼Œé‡æ–°æ¸²æŸ“å¡ç‰‡
        if (!categoryToolsGrid.classList.contains('hidden')) {
          const currentCategoryBtn = document.querySelector('.category-btn.bg-sakura-50, .category-btn[class*="bg-sakura"]');
          if (currentCategoryBtn) {
            const categoryId = currentCategoryBtn.dataset.category;
            if (categoryId !== 'all') {
              const categoryTools = window.toolsData.filter(tool => tool.category === categoryId);
              renderToolCards(categoryTools, locale);
            }
          }
        }
        
        console.log('Language changed to:', locale);
      });
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
      if (!languageToggleBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
        languageDropdown.classList.add('hidden');
      }
    });

    // æ¸²æŸ“å·¥å…·å¡ç‰‡
    function renderToolCards(categoryTools, locale) {
      const t = translations[locale] || translations['en'];
      
      if (categoryTools.length === 0) {
        toolsGrid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      toolsGrid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      toolsGrid.innerHTML = categoryTools.map(tool => {
        // å°è¯•ä»é¡¶çº§ç¿»è¯‘å¯¹è±¡ä¸­è·å–å·¥å…·ç¿»è¯‘
        const translatedName = t[tool.id] || tool.name;
        const translatedDesc = t[tool.id + '_desc'] || tool.description;
        
        return `
          <div class="group cursor-pointer tool-card" data-tool-url="${tool.url}" data-tool-id="${tool.id}">
            <div class="relative overflow-hidden rounded-xl p-6 h-48 bg-gradient-to-br from-sakura-400 to-sakura-600 hover:from-sakura-500 hover:to-sakura-700 transform hover:scale-105 transition-all duration-300 ease-out shadow-lg hover:shadow-xl text-white" style="background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);">
              <div class="absolute top-0 right-0 opacity-20">
                <div class="w-32 h-32 rounded-full bg-white transform translate-x-8 -translate-y-8"></div>
              </div>
              <div class="absolute bottom-0 left-0 opacity-10">
                <div class="w-24 h-24 rounded-full bg-white transform -translate-x-4 translate-y-4"></div>
              </div>
              <div class="relative z-10 h-full flex flex-col">
                <div class="flex items-start justify-between mb-3 gap-2">
                  <h3 class="text-xl font-bold line-clamp-2 flex-1 tool-card-name">${translatedName}</h3>
                  <div class="flex items-center gap-1 flex-shrink-0">
                    ${tool.thirdParty ? `<span class="bg-white/20 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full whitespace-nowrap third-party-badge"><span class="third-party-text">${t.third_party_text}</span></span>` : ''}
                    <svg class="w-4 h-4 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                  </div>
                </div>
                <p class="text-white/90 text-sm line-clamp-3 flex-1 tool-card-desc">${translatedDesc}</p>
                <div class="flex flex-wrap gap-1 mt-3">
                  ${tool.tags.slice(0, 2).map(tag => `
                    <span class="bg-white/20 backdrop-blur-sm text-xs px-2 py-1 rounded-full">${tag}</span>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // ä¸ºå¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.tool-card').forEach(card => {
        card.addEventListener('click', () => {
          const url = card.dataset.toolUrl;
          window.open(url, '_blank');
        });
      });
    }

    // åˆ†ç±»åˆ‡æ¢
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        console.log('Category button clicked:', btn.dataset.category);
        const categoryId = btn.dataset.category;
        const t = translations[currentLocale] || translations['en'];
        
        // æ›´æ–°æ´»åŠ¨çŠ¶æ€
        categoryButtons.forEach(b => {
          b.className = b.className.replace(/bg-sakura-\w+|text-sakura-\w+|border-sakura-\w+/g, '');
          b.className = b.className.replace('bg-sakura-50 dark:bg-sakura-900/20 text-sakura-600 dark:text-sakura-400 border border-sakura-200 dark:border-sakura-800', '');
          b.className += ' text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700';
        });
        
        btn.className = btn.className.replace('text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700', '');
        btn.className += ' bg-sakura-50 dark:bg-sakura-900/20 text-sakura-600 dark:text-sakura-400 border border-sakura-200 dark:border-sakura-800';
        
        // åˆ¤æ–­æ˜¯å¦ä¸º"æ‰€æœ‰å·¥å…·"
        if (categoryId === 'all') {
          // æ˜¾ç¤ºåˆ—è¡¨è§†å›¾ï¼Œéšè—å¡ç‰‡è§†å›¾
          allToolsList.classList.remove('hidden');
          categoryToolsGrid.classList.add('hidden');
          // æ˜¾ç¤ºä»‹ç»section
          if (introSection) introSection.classList.remove('hidden');
          
          categoryTitle.innerHTML = `<img src="/icons/classification/all.png" alt="All Tools" class="mr-3 w-8 h-8 object-contain inline-block" />${t.all_tools || 'All Tools'}`;
          categoryDescription.textContent = t.all_tools_desc || 'Collection of all practical tools to boost your productivity';
          
          toolsCount.textContent = window.toolsData.length;
          const toolsCountUnit = document.getElementById('tools-count-unit');
          if (toolsCountUnit) {
            toolsCountUnit.textContent = t.tools_count;
          }
        } else {
          // æ˜¾ç¤ºå¡ç‰‡è§†å›¾ï¼Œéšè—åˆ—è¡¨è§†å›¾
          allToolsList.classList.add('hidden');
          categoryToolsGrid.classList.remove('hidden');
          // éšè—ä»‹ç»section
          if (introSection) introSection.classList.add('hidden');
          
          const category = window.categoriesData.find(cat => cat.id === categoryId);
          const categoryTools = window.toolsData.filter(tool => tool.category === categoryId);

          // æ›´æ–°æ ‡é¢˜ï¼ˆä½¿ç”¨ç¿»è¯‘ï¼‰
          const translatedName = (t.categories && t.categories[categoryId]) || category.name;
          const translatedDesc = (t.category_descriptions && t.category_descriptions[categoryId]) || category.description;
          
          categoryTitle.innerHTML = `<img src="${category.icon}" alt="${translatedName}" class="mr-3 w-8 h-8 object-contain inline-block" />${translatedName}`;
          categoryDescription.textContent = translatedDesc;
          
          // æ›´æ–°å·¥å…·è®¡æ•°æ–‡æœ¬
          toolsCount.textContent = categoryTools.length;
          const toolsCountUnit = document.getElementById('tools-count-unit');
          if (toolsCountUnit) {
            toolsCountUnit.textContent = t.tools_count;
          }
          
          // æ¸²æŸ“å¡ç‰‡
          renderToolCards(categoryTools, currentLocale);
        }
      });
    });
  });
</script>

<style>
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
  aside {
    scrollbar-width: thin;
    scrollbar-color: #e5e7eb transparent;
  }
  
  aside::-webkit-scrollbar {
    width: 6px;
  }
  
  aside::-webkit-scrollbar-track {
    background: transparent;
  }
  
  aside::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 3px;
  }
  
  aside::-webkit-scrollbar-thumb:hover {
    background: #d1d5db;
  }

  /* æ–‡æœ¬æˆªæ–­ */
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>