---
import { detectLocale, getTextDirection, SUPPORTED_LOCALES, type Locale } from '../utils/i18n';
import '../styles/global.css';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  locale?: Locale;
  ogImage?: string;
  canonicalUrl?: string;
  noindex?: boolean;
}

const {
  title = 'OumaShu - Tools Directory',
  description = 'Minimal Japanese-style hub for your micro tools. All-in-one entry for productivity apps.',
  keywords = 'tools, productivity, directory, apps, utilities',
  locale = detectLocale(),
  ogImage = '/og/default.jpg',
  canonicalUrl = Astro.url.href,
  noindex = false
} = Astro.props;

const textDirection = getTextDirection(locale);
const siteName = 'OumaShu';

// 构建 hreflang 链接
const hreflangs = SUPPORTED_LOCALES.map(lang => ({
  lang: lang,
  url: lang === 'en' ? Astro.url.origin : `${Astro.url.origin}/${lang}`
}));

// 结构化数据
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": siteName,
  "description": description,
  "url": Astro.url.origin,
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${Astro.url.origin}/search?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  },
  "publisher": {
    "@type": "Organization",
    "name": siteName,
    "logo": {
      "@type": "ImageObject", 
      "url": `${Astro.url.origin}/favicon.svg`
    }
  }
};
---

<!DOCTYPE html>
<html lang={locale} dir={textDirection} data-theme="light" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 基础 SEO -->
  <title>{title}</title>
  <meta name="description" content={description}>
  <meta name="keywords" content={keywords}>
  <link rel="canonical" href={canonicalUrl}>
  
  <!-- Robots -->
  {noindex && <meta name="robots" content="noindex, nofollow">}
  
  <!-- Open Graph -->
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:image" content={new URL(ogImage, Astro.url.origin).href}>
  <meta property="og:url" content={canonicalUrl}>
  <meta property="og:type" content="website">
  <meta property="og:site_name" content={siteName}>
  <meta property="og:locale" content={locale}>
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  <meta name="twitter:image" content={new URL(ogImage, Astro.url.origin).href}>
  
  <!-- Hreflang -->
  {hreflangs.map(({ lang, url }) => (
    <link rel="alternate" hreflang={lang} href={url}>
  ))}
  <link rel="alternate" hreflang="x-default" href={Astro.url.origin}>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Theme -->
  <meta name="theme-color" content="#fff5f7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  
  <!-- Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://pagead2.googlesyndication.com">
  
  <!-- 关键CSS内联 -->
  <style>
    /* CSS变量定义 */
    :root {
      --color-bg: #fff5f7;
      --color-fg: #111827;
      --color-card: #ffffff;
      --color-brand: #e91e63;
      --color-accent: #4ade80;
      --color-border: #e5e7eb;
      --color-muted: #6b7280;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', 'Hiragino Sans GB', sans-serif;
      --transition-normal: 250ms ease;
    }
    
    :root[data-theme='dark'] {
      --color-bg: #000000;
      --color-fg: #e5e7eb;
      --color-card: #111111;
      --color-brand: #ff5c8a;
      --color-accent: #34d399;
      --color-border: #2a2a2a;
      --color-muted: #9ca3af;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html {
      font-family: var(--font-sans);
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      padding: 0;
      background-color: var(--color-bg);
      color: var(--color-fg);
      line-height: 1.6;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }
    
    .sakura-gradient {
      background: linear-gradient(135deg, var(--color-bg), var(--color-card));
    }
  </style>

  <!-- 主题初始化脚本 (防止闪烁) -->
  <script is:inline>
    (function() {
      function getTheme() {
        const stored = localStorage.getItem('theme');
        if (stored && ['light', 'dark', 'system'].includes(stored)) {
          return stored === 'system' 
            ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
            : stored;
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      const theme = getTheme();
      document.documentElement.setAttribute('data-theme', theme);
      
      // 更新 meta theme-color
      const metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (metaThemeColor) {
        metaThemeColor.setAttribute('content', theme === 'dark' ? '#000000' : '#fff5f7');
      }
    })();
  </script>
  
  <!-- AdSense 脚本 -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
  
  <!-- 结构化数据 -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
  
  <!-- Google Analytics 4 (可选) -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX');
  </script> -->
</head>

<body class="min-h-screen sakura-gradient">
  <!-- Skip to main content (accessibility) -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-pink-500 text-white px-4 py-2 rounded-md z-50">
    Skip to main content
  </a>
  
  <!-- Page content -->
  <slot />
  
  <!-- 页面加载指示器 -->
  <div id="page-loader" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 bg-pink-500 rounded-full animate-bounce"></div>
      <div class="w-3 h-3 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
      <div class="w-3 h-3 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
    </div>
  </div>
  
  <!-- Service Worker 注册 (可选) -->
  <script is:inline>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => console.log('SW registered'))
          .catch(error => console.log('SW registration failed'));
      });
    }
  </script>
  
  <!-- 页面性能监控 -->
  <script is:inline>
    // 监控 Core Web Vitals
    function reportWebVitals({name, value, id}) {
      // 发送到分析服务
      if (typeof gtag !== 'undefined') {
        gtag('event', name, {
          event_category: 'Web Vitals',
          value: Math.round(name === 'CLS' ? value * 1000 : value),
          event_label: id,
          non_interaction: true,
        });
      }
    }
    
    // 动态导入 web-vitals 库
    if (typeof window !== 'undefined') {
      import('https://unpkg.com/web-vitals@3/dist/web-vitals.js')
        .then(({onCLS, onFID, onFCP, onLCP, onTTFB}) => {
          onCLS(reportWebVitals);
          onFID(reportWebVitals);
          onFCP(reportWebVitals);
          onLCP(reportWebVitals);
          onTTFB(reportWebVitals);
        })
        .catch(err => console.log('Web Vitals not loaded:', err));
    }
  </script>
</body>
</html>

<style is:global>
  /* 全局样式增强 */
  html {
    font-family: var(--font-sans);
    scroll-behavior: smooth;
  }
  
  body {
    background: var(--color-bg);
    color: var(--color-fg);
    line-height: 1.6;
    transition: background-color var(--transition-normal), color var(--transition-normal);
  }
  
  /* Screen reader only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  .sr-only.focus\:not-sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: 0.5rem 1rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }
  
  /* 文本截断工具类 */
  .line-clamp-1 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
  }
  
  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  
  .line-clamp-3 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  
  /* 加载状态样式 */
  .loading {
    pointer-events: none;
    opacity: 0.6;
  }
  
  /* 动画 */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  
  /* 自定义滚动条 */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--color-bg);
  }
  
  ::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: var(--color-muted);
  }
  
  /* 选择文本样式 */
  ::selection {
    background-color: color-mix(in srgb, var(--color-brand) 20%, transparent);
    color: var(--color-fg);
  }
  
  /* 焦点样式 */
  :focus-visible {
    outline: 2px solid var(--color-brand);
    outline-offset: 2px;
  }
</style>
